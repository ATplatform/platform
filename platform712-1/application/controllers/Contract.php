<?phpdefined('BASEPATH') OR exit('No direct script access allowed');class Contract extends CI_Controller{    public function __construct()    {        parent::__construct();        session_start();        //打开重定向        $this->load->helper('url');        $this->load->database();        $this->user_per_page = $this->config->item('user_per_page');        $this->at_url=$this->config->item('at_url');    }    public function index()    {        if (!isset($_SESSION['username'])) {            redirect('Login');        }        redirect('Contract/contractList');    }    /////////////////////////////////////////////////////////////////////////////////////////////////    ////////////////////////////////////////contractList/////////////////////////////////////////////    /////////////////////////////////////////////////////////////////////////////////////////////////    /////////////数据展示///////////////    public function contractList()    {        if (!isset($_SESSION['username'])) {            redirect('Login');        }        $this->load->model('Contract_model');        $username=$_SESSION['username'];        $village_id = $_SESSION['village_id'];        $begin_date=$this->input->get('begin_date');        $type = $this->input->get('type');        $level=$this->input->get('level');        $keyword = $this->input->get('keyword');        $page = $this->input->get('page');        $page = $page ? $page : '1';        $data['nav'] = 'contractList';        $data['keyword'] = $keyword;        $data['type'] = $type;        $data['level'] = $level;        $data['begin_date'] = $begin_date;        $data['username'] = $username;        $data['at_url']= $this->at_url;        $total = $this->Contract_model->getContractListTotal($begin_date, $type, $keyword, $level,$this->user_per_page);        $data['total'] = $total;        $data['page'] = $page >= $total ? $total : $page;        $data['pagesize'] = $this->user_per_page;        $this->load->view('app/contract_list', $data);    }    //////////////////////查询数据///////////////    public function getContractList()    {        $begin_date=$this->input->get('begin_date');        $type = $this->input->get('type');        $level = $this->input->get('level');        $keyword = $this->input->get('keyword');        $page = $this->input->get('page');        $page = $page ? $page : '1';        $this->load->model('Contract_model');        $sql = $this->Contract_model->sqlTogetContractList($begin_date,$type, $level, $keyword, $page, $this->user_per_page);        $data = $this->Contract_model->getContractList($sql);        echo $data;    }    public function insert(){            $code = $this->input->post('code');            $type = $this->input->post('type');            $level = $this->input->post('level');            $signed_with=$this->input->post('signed_with');            $amount=$this->input->post('amount');        $position_code=$this->input->post('position_code');            $begin_date=$this->input->post('begin_date');            $end_date=$this->input->post('end_date');            $remark = $this->input->post('remark');            $additional = $this->input->post('additional');            $create_time = date('Y-m-d h:i:s', time());            $this->load->model('Contract_model');         /*   $flag =$this->Material_model-> defineUsageEffective($material_code,$effective_date);            if ($flag) {                $data['message'] = '同一物资每天只能修改一次';                $data['datebug']=true;            } else {                $data['datebug']=false;*/                    $result=$this->Contract_model->insert($code,$type,$level,$signed_with,$amount, $position_code,$begin_date,$end_date,$remark,$additional,$create_time);            $total = $this->Contract_model->getContractListTotal($begin_date,$type,'',$level,$this->user_per_page);            $data['total'] = $total;            print_r(json_encode($data));    }    public function getLatestCode()    {        $this->load->model('Contract_model');        $res = $this->Contract_model->getLatestCode();        echo $res;    }    public function getposition_code()    {        $this->load->model('Contract_model');        $res = $this->Contract_model->getposition_code();        print_r(json_encode($res));    }    public function upload()    {        //得到服务器地址        // $url = $_SERVER['SERVER_NAME'];        $url = $_SERVER['SERVER_ADDR'];        $base_url = 'http://'.$url;        $pushserver_address=$base_url;        $filepath  = "/work/www/platform6/upload/Contracts/";        //生成一个随机数,用于把缓图片重命名,避免重复        $addtionalname = $_FILES['cardnumber']['name'];        $tmp = $_FILES['cardnumber']['tmp_name'];        if (!file_exists($filepath)){            mkdir($filepath,0777,true);        }        if(file_exists( $filepath.$addtionalname)){            $addtionalname= $addtionalname.time().rand(1,10000);        }        if(move_uploaded_file($tmp,$filepath.$addtionalname)){            $message = "上传成功";            $res = array(array('message'=>"上传成功"),array('imgname'=>$addtionalname),array('filepath'=>$pushserver_address."/platform6/upload/Contracts/".$addtionalname));            echo json_encode($res);        }        return false;    }    public function download(){        $file_path = $this->input->post('download');        header("Content-type:text/html;charset=utf-8");        //$file_path="testMe.txt";        //用以解决中文不能显示出来的问题        //$file_name=iconv("utf-8","gb2312",$file_name);        //$file_sub_path=$_SERVER['DOCUMENT_ROOT']."marcofly/phpstudy/down/down/";        //$file_path=$file_sub_path.$file_name;        //首先要判断给定的文件存在与否        if(!file_exists($file_path)){            echo "没有该文件文件";            return ;        }        $fp=fopen($file_path,"r");        $file_size=filesize($file_path);        //下载文件需要用到的头        Header("Content-type: application/octet-stream");        Header("Accept-Ranges: bytes");        Header("Accept-Length:".$file_size);        Header("Content-Disposition: attachment; filename=".$file_path);        $buffer=1024;        $file_count=0;        //向浏览器返回数据        while(!feof($fp) && $file_count<$file_size){            $file_con=fread($fp,$buffer);            $file_count+=$buffer;            echo $file_con;        }        fclose($fp);    }}
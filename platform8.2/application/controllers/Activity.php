<?phpdefined('BASEPATH') OR exit('No direct script access allowed');class Activity extends CI_Controller{    public function __construct()    {        parent::__construct();        session_start();        //打开重定向        $this->load->helper('url');        $this->load->database();        $this->user_per_page = $this->config->item('user_per_page');    }    public function index()    {        if (!isset($_SESSION['username'])) {            redirect('Login');        }        redirect('Activity/activityList');    }    /////////////////////////////////////////////////////////////////////////////////////////////////    ////////////////////////////////////////activityList/////////////////////////////////////////////    /////////////////////////////////////////////////////////////////////////////////////////////////    /////////////数据展示///////////////    public function activityList()    {        if (!isset($_SESSION['username'])) {            redirect('Login');        }        $this->load->model('Activity_model');        $username=$_SESSION['username'];        $username= $this->Activity_model->getUserName($username);        $begin_date=$this->input->get('begin_date');        $type = $this->input->get('type');        $keyword = $this->input->get('keyword');        $page = $this->input->get('page');        $page = $page ? $page : '1';        $data['nav'] = 'activityList';        $data['keyword'] = $keyword;        $data['type'] = $type;        $data['begin_date'] = $begin_date;        $data['username'] = $username;        $total = $this->Activity_model->getListTotal($begin_date, $type, $keyword,$this->user_per_page);        $data['total'] = $total;        $data['page'] = $page >= $total ? $total : $page;        $data['pagesize'] = $this->user_per_page;        $this->load->view('app/activity_list', $data);    }    //////////////////////查询数据///////////////    public function getList()    {        $begin_date=$this->input->get('begin_date');        $type = $this->input->get('type');        $keyword = $this->input->get('keyword');        $page = $this->input->get('page');        $page = $page ? $page : '1';        $this->load->model('Activity_model');        $sql = $this->Activity_model->sqlTogetList($begin_date,$type, $keyword, $page, $this->user_per_page);        $data = $this->Activity_model->getList($sql);        echo $data;    }    public function insert(){            $code = $this->input->post('code');            $type = $this->input->post('type');            $name=$this->input->post('name');            $person_code=$this->input->post('person_code');            $service_code=$this->input->post('service_code');            $begin_date=$this->input->post('begin_date');            $end_date=$this->input->post('end_date');            $create_time = date('Y-m-d h:i:s', time());            $this->load->model('Activity_model');         /*   $flag =$this->Material_model-> defineUsageEffective($material_code,$effective_date);            if ($flag) {                $data['message'] = '同一物资每天只能修改一次';                $data['datebug']=true;            } else {                $data['datebug']=false;*/         $this->Activity_model->insert($code,$type,$name,$person_code,$service_code, $begin_date,$end_date,$create_time);            $total = $this->Activity_model->getListTotal($begin_date,$type,'',$this->user_per_page);            $data['total'] = $total;            print_r(json_encode($data));    }    public function getLatestCode()    {        $this->load->model('Activity_model');        $res = $this->Activity_model->getLatestCode();        echo $res;    } public function getservice_code(){     $this->load->model('Activity_model');     $res = $this->Activity_model->getservice_code();     print_r(json_encode($res)); }    public function getactivity_codeUrl(){        $this->load->model('Activity_model');        $res = $this->Activity_model->getactivity_codeUrl();        print_r(json_encode($res));    }    //////////////////////////////////////////////////////////////////////////////////////////    public function activityRecord()    {        if (!isset($_SESSION['username'])) {            redirect('Login');        }        $this->load->model('Activity_model');        $username=$_SESSION['username'];        $username= $this->Activity_model->getUserName($username);        $date=$this->input->get('date');        $type = $this->input->get('type');        $keyword = $this->input->get('keyword');        $page = $this->input->get('page');        $page = $page ? $page : '1';        $data['nav'] = 'activityRecord';        $data['keyword'] = $keyword;        $data['type'] = $type;        $data['date'] = $date;        $data['username'] = $username;        $total = $this->Activity_model->getRecordTotal($date, $type, $keyword,$this->user_per_page);        $data['total'] = $total;        $data['page'] = $page >= $total ? $total : $page;        $data['pagesize'] = $this->user_per_page;        $this->load->view('app/activity_record', $data);    }    public function getRecord()    {        $date=$this->input->get('date');        $type = $this->input->get('type');        $keyword = $this->input->get('keyword');        $page = $this->input->get('page');        $page = $page ? $page : '1';        $this->load->model('Activity_model');        $sql = $this->Activity_model->sqlTogetRecord($date,$type, $keyword, $page, $this->user_per_page);        $data = $this->Activity_model->getRecord($sql);        echo $data;    }    public function insertRecord(){        $code = $this->input->post('code');        $person_code=$this->input->post('person_code');        $service_code=$this->input->post('service_code');        $date=$this->input->post('date');        $create_time = date('Y-m-d h:i:s', time());        $this->load->model('Activity_model');        /*   $flag =$this->Material_model-> defineUsageEffective($material_code,$effective_date);           if ($flag) {               $data['message'] = '同一物资每天只能修改一次';               $data['datebug']=true;           } else {               $data['datebug']=false;*/        $this->Activity_model->insertRecord($code,$person_code,$service_code, $date,$create_time);        $total = $this->Activity_model->getRecordTotal($date,'','',$this->user_per_page);        $data['total'] = $total;        print_r(json_encode($data));    }}